rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Users collection - allow users to read/write their own data and read others for search
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow read: if true; // Allow public read access for seller information
      allow create: if request.auth != null;
    }
    
    // User subcollections (addresses, wishlist, cart, notifications)
    match /users/{userId}/{subcollection=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Chat rules - allow if user is participant
    match /chats/{chatId} {
      allow read, write: if request.auth != null && 
        (request.auth.uid in resource.data.participants ||
         request.auth.uid in request.resource.data.participants);
      allow create: if request.auth != null && 
        request.auth.uid in request.resource.data.participants;
    }
    
    // Messages in chats - allow if user is participant of parent chat
    match /chats/{chatId}/messages/{messageId} {
      allow read, write, create: if request.auth != null;
    }
    
    // Products collection - allow read for all (including non-authenticated), write for owners/sellers
    match /products/{productId} {
      allow read: if true; // Allow public read access
      allow write: if request.auth != null && 
        (request.auth.uid == resource.data.sellerId ||
         request.auth.uid == request.resource.data.sellerId);
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.sellerId;
    }
    
    // Product subcollections (comments, reviews)
    match /products/{productId}/{subcollection=**} {
      allow read: if true; // Allow public read access for comments and reviews
      allow write, create: if request.auth != null;
    }
    
    // Stories collection - allow read for all (including non-authenticated), write for owners
    match /stories/{storyId} {
      allow read: if true; // Allow public read access
      allow write: if request.auth != null && 
        (request.auth.uid == resource.data.userId ||
         request.auth.uid == request.resource.data.userId);
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId;
    }
    
    // Orders collection - allow read/write for buyer and seller
    match /orders/{orderId} {
      allow read, write: if request.auth != null && 
        (request.auth.uid == resource.data.buyerId || 
         request.auth.uid == resource.data.sellerId ||
         request.auth.uid == request.resource.data.buyerId ||
         request.auth.uid == request.resource.data.sellerId);
      allow create: if request.auth != null && 
        (request.auth.uid == request.resource.data.buyerId ||
         request.auth.uid == request.resource.data.sellerId);
    }
    
    // Reviews collection - allow read for all, write for reviewers
    match /reviews/{reviewId} {
      allow read: if true; // Allow public read access for reviews
      allow write: if request.auth != null && 
        (request.auth.uid == resource.data.userId ||
         request.auth.uid == request.resource.data.userId);
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId;
    }
    
    // Sellers collection - allow read for all, write for own profile
    match /sellers/{sellerId} {
      allow read: if true; // Allow public read access for seller profiles
      allow write: if request.auth != null && request.auth.uid == sellerId;
      allow create: if request.auth != null && request.auth.uid == sellerId;
    }
    
    // Categories collection - allow read for all, write for admins only
    match /categories/{categoryId} {
      allow read: if true; // Allow public read access for categories
      allow write, create: if request.auth != null; // Allow for now, can restrict to admins later
    }
    
    // Follows/Following relationships
    match /follows/{followId} {
      allow read: if request.auth != null;
      allow write, create: if request.auth != null && 
        (request.auth.uid == resource.data.followerId ||
         request.auth.uid == request.resource.data.followerId);
    }
    
    // Reels collection - allow read for all (including non-authenticated), write for creators
    match /reels/{reelId} {
      allow read: if true; // Allow public read access
      allow write: if request.auth != null && 
        (request.auth.uid == resource.data.userId ||
         request.auth.uid == request.resource.data.userId);
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId;
    }
    
    // Reel comments - allow read for all, write for authenticated users
    match /reels/{reelId}/comments/{commentId} {
      allow read: if true;
      allow write, create: if request.auth != null;
    }
    
    // Addresses collection (under users)
    match /addresses/{addressId} {
      allow read, write, create: if request.auth != null;
    }
    
    // Admin-related collections
    match /admin/{document=**} {
      allow read, write, create: if request.auth != null; // Can be restricted to admin users later
    }
    
    // Analytics and stats
    match /analytics/{document=**} {
      allow read, write, create: if request.auth != null;
    }
    
    // Notifications
    match /notifications/{notificationId} {
      allow read, write: if request.auth != null && 
        (request.auth.uid == resource.data.userId ||
         request.auth.uid == request.resource.data.userId);
      allow create: if request.auth != null;
    }
    
    // Email collection - for Firebase email extension
    match /mail/{emailId} {
      allow create: if request.auth != null;
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
    }
    
    // Email notifications tracking
    match /emailNotifications/{notificationId} {
      allow create: if request.auth != null;
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      allow update: if request.auth != null && request.auth.uid == resource.data.userId;
    }
    
    // Carts collection
    match /carts/{cartId} {
      allow read, write, create, delete: if request.auth != null && request.auth.uid == cartId;
    }
    
    // Wishlists collection
    match /wishlists/{userId} {
      allow read, write, create, delete: if request.auth != null && request.auth.uid == userId;
    }
    
    // Reports and feedback
    match /reports/{reportId} {
      allow read, write, create: if request.auth != null;
    }
    
    // Settings and configuration
    match /settings/{settingId} {
      allow read: if request.auth != null;
      allow write, create: if request.auth != null; // Can be restricted to admins later
    }
    
    // User presence - allow users to read all presence data and write only their own
    match /userPresence/{userId} {
      allow read: if request.auth != null;
      allow write, create, update, delete: if request.auth != null && request.auth.uid == userId;
    }
    
    // Backup rule - allow authenticated users to access any document
    // This ensures nothing breaks while you're developing
    match /{document=**} {
      allow read, write, create, delete: if request.auth != null;
    }
  }
}